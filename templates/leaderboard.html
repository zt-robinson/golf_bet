{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    body {
        background-color: #212529 !important; /* Dark gray background */
        color: #f8f9fa !important; /* Light text for the whole page */
    }
    .table-dark {
        --bs-table-bg: #2b3035; /* Custom darker table background */
        --bs-table-striped-bg: #343a40;
    }
    .cut-row {
        color: #6c757d !important; /* Muted gray for cut player text */
        font-style: italic;
    }
    .cut-row:hover {
        background-color: #343a40;
    }
    h1, .btn-link {
        color: #f8f9fa !important;
    }
    .countdown {
        color: #ffc107 !important; /* Yellow for countdown */
        font-weight: bold;
    }
</style>
{% endblock %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tournament_name }} - Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

{% block title %}Leaderboard - {{ tournament_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">
            <i class="fas fa-clipboard-list me-3"></i>
            {{ tournament_name }}
        </h1>
        <a href="{{ url_for('home') }}" class="btn btn-link ps-0">
            <i class="fas fa-arrow-left me-1"></i>Back to Tournament List
        </a>
    </div>

    {% if round_is_over and current_round < 4 %}
        <form action="{{ url_for('next_round', tournament_id=tournament_id) }}" method="POST">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-play-circle me-2"></i>Begin Round {{ current_round + 1 }}
            </button>
        </form>
    {% elif status == 'active' %}
    <span class="badge bg-danger fs-5">
        <i class="fas fa-satellite-dish me-2"></i>Live - Round {{ current_round }}
    </span>
    {% elif status == 'completed' %}
    <span class="badge bg-success fs-5">
        <i class="fas fa-check-circle me-2"></i>Completed
    </span>
    {% endif %}
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Error:</strong> {{ error }}
</div>
{% elif not players %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    The tournament is about to begin. Scores will appear here once the first group has started.
</div>
{% else %}
<div class="table-responsive">
    <table class="table table-dark table-striped table-hover">
        <thead>
            <tr>
                <th scope="col">Pos</th>
                <th scope="col">Player</th>
                <th scope="col" class="text-center">To Par</th>
                <th scope="col" class="text-center">THRU</th>
                <th scope="col" class="text-center">R1</th>
                <th scope="col" class="text-center">R2</th>
                <th scope="col" class="text-center">R3</th>
                <th scope="col" class="text-center">R4</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            
            {% set score_class = '' %}
            {% if player.status != 'cut' and player.has_teed_off %}
                {% if player.score_to_par < 0 %}
                    {% set score_class = 'score-negative' %}
                {% elif player.score_to_par == 0 %}
                    {% set score_class = 'score-even' %}
                {% else %}
                    {% set score_class = 'score-positive' %}
                {% endif %}
            {% endif %}

            <tr class="{% if player.status == 'cut' %}cut-row{% endif %}">
                <td class="fw-bold">
                    {% if player.status == 'cut' %}
                        --
                    {% elif player.has_started_tournament and player.position %}
                        {% set is_tied = false %}
                        {% if loop.previtem and player.position == loop.previtem.position %}
                            {% set is_tied = true %}
                        {% endif %}
                        {% if loop.nextitem and player.position == loop.nextitem.position %}
                            {% set is_tied = true %}
                        {% endif %}

                        {% if is_tied %}T{% endif %}{{ player.position }}
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>{{ player.player_name }}</td>
                <td class="text-center fw-bold">
                    {% if player.status == 'cut' %}
                        CUT
                    {% elif not player.has_started_tournament %}
                        -
                    {% elif player.score_to_par == 0 %}
                        <span style="color: #28a745 !important;">E</span>
                    {% elif player.score_to_par > 0 %}
                        <span style="color: #f8f9fa !important;">+{{ player.score_to_par | int }}</span>
                    {% else %}
                        <span style="color: #dc3545 !important;">{{ player.score_to_par | int }}</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.status == 'cut' %}
                        CUT
                    {% elif not player.has_teed_off %}
                        <span class="countdown" data-tee-time="{{ player.tee_time_step }}"></span>
                    {% elif player.holes_played >= 18 %}
                        F
                    {% else %}
                        {{ player.holes_played }}
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.r1_info.display is not none %}
                        {% if player.r1_info.finished %}
                            {{ player.r1_info.strokes }}
                        {% else %}
                            {% if player.r1_info.display == 'E' %}
                                <span style="color: #28a745 !important;">E</span>
                            {% elif player.r1_info.score_to_par > 0 %}
                                <span style="color: #f8f9fa !important;">+{{ player.r1_info.score_to_par }}</span>
                            {% else %}
                                <span style="color: #dc3545 !important;">{{ player.r1_info.score_to_par }}</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.r2_info.display is not none %}
                        {% if player.r2_info.finished %}
                            {{ player.r2_info.strokes }}
                        {% else %}
                            {% if player.r2_info.display == 'E' %}
                                <span style="color: #28a745 !important;">E</span>
                            {% elif player.r2_info.score_to_par > 0 %}
                                <span style="color: #f8f9fa !important;">+{{ player.r2_info.score_to_par }}</span>
                            {% else %}
                                <span style="color: #dc3545 !important;">{{ player.r2_info.score_to_par }}</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.status == 'cut' %}
                        -
                    {% elif player.r3_info.display is not none %}
                        {% if player.r3_info.finished %}
                            {{ player.r3_info.strokes }}
                        {% else %}
                            {% if player.r3_info.display == 'E' %}
                                <span style="color: #28a745 !important;">E</span>
                            {% elif player.r3_info.score_to_par > 0 %}
                                <span style="color: #f8f9fa !important;">+{{ player.r3_info.score_to_par }}</span>
                            {% else %}
                                <span style="color: #dc3545 !important;">{{ player.r3_info.score_to_par }}</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.status == 'cut' %}
                        -
                    {% elif player.r4_info.display is not none %}
                        {% if player.r4_info.finished %}
                            {{ player.r4_info.strokes }}
                        {% else %}
                            {% if player.r4_info.display == 'E' %}
                                <span style="color: #28a745 !important;">E</span>
                            {% elif player.r4_info.score_to_par > 0 %}
                                <span style="color: #f8f9fa !important;">+{{ player.r4_info.score_to_par }}</span>
                            {% else %}
                                <span style="color: #dc3545 !important;">{{ player.r4_info.score_to_par }}</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if status == 'active' and not round_is_over %}
<script>
    // Update countdown timers
    function updateCountdowns() {
        const countdownElements = document.querySelectorAll('.countdown');
        countdownElements.forEach(function(element) {
            const teeTimeStep = parseInt(element.dataset.teeTime);
            const currentStep = {{ simulation_step }};
            const timeUntilTee = teeTimeStep - currentStep;
            
            if (timeUntilTee > 0) {
                element.textContent = timeUntilTee + 's';
            } else {
                element.textContent = 'Teeing Off';
            }
        });
    }
    
    // Set initial text for countdown elements
    document.querySelectorAll('.countdown').forEach(function(element) {
        const teeTimeStep = parseInt(element.dataset.teeTime);
        const currentStep = {{ simulation_step }};
        if (teeTimeStep > currentStep) {
            element.textContent = (teeTimeStep - currentStep) + 's';
        } else {
            element.textContent = 'Teeing Off';
        }
    });

    // Update countdowns every second
    setInterval(updateCountdowns, 1000);
    
    // Auto-refresh the page
    setTimeout(function() {
        window.location.reload();
    }, 1000);
</script>
{% elif status == 'active' and round_is_over and current_round == 4 %}
<script>
    // Final refresh to pick up status change to 'completed'
    setTimeout(function() {
        window.location.reload();
    }, 1000);
</script>
{% endif %}

{% endblock %}