{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    body {
        background-color: #f8f9fa !important;
    }
    .score-negative { color: #d00 !important; }
    .score-even { color: #080 !important; }
    .score-positive { color: #333 !important; }
    .countdown {
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tournament_name }} - Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

{% block title %}Leaderboard - {{ tournament_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">
            <i class="fas fa-clipboard-list me-3"></i>
            {{ tournament_name }}
        </h1>
        <a href="{{ url_for('home') }}" class="btn btn-link ps-0">
            <i class="fas fa-arrow-left me-1"></i>Back to Tournament List
        </a>
    </div>

    {% if round_is_over and current_round < 4 %}
        <form action="{{ url_for('next_round', tournament_id=tournament_id) }}" method="POST">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-play-circle me-2"></i>Begin Round {{ current_round + 1 }}
            </button>
        </form>
    {% elif status == 'active' %}
    <span class="badge bg-danger fs-5">
        <i class="fas fa-satellite-dish me-2"></i>Live - Round {{ current_round }}
    </span>
    {% elif status == 'completed' %}
    <span class="badge bg-success fs-5">
        <i class="fas fa-check-circle me-2"></i>Completed
    </span>
    {% endif %}
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Error:</strong> {{ error }}
</div>
{% elif not players %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    The tournament is about to begin. Scores will appear here once the first group has started.
</div>
{% else %}
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th scope="col">Pos</th>
                <th scope="col">Player</th>
                <th scope="col" class="text-center">To Par</th>
                <th scope="col" class="text-center">THRU</th>
                <th scope="col" class="text-center">R1</th>
                <th scope="col" class="text-center">R2</th>
                <th scope="col" class="text-center">R3</th>
                <th scope="col" class="text-center">R4</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr class="{% if player.status == 'cut' %}fst-italic text-muted{% endif %}">
                <td class="fw-bold">
                    {% if player.position %}
                        {% set is_tied = false %}
                        {% if loop.previtem and player.position == loop.previtem.position %}
                            {% set is_tied = true %}
                        {% endif %}
                        {% if loop.nextitem and player.position == loop.nextitem.position %}
                            {% set is_tied = true %}
                        {% endif %}

                        {% if is_tied %}T{% endif %}{{ player.position }}
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>{{ player.player_name }}</td>
                <td class="text-center fw-bold
                    {% if player.score_to_par < 0 %}score-negative{% endif %}
                    {% if player.score_to_par == 0 %}score-even{% endif %}
                    {% if player.score_to_par > 0 %}score-positive{% endif %}
                ">
                    {% if player.score_to_par == 0 %}
                        E
                    {% elif player.score_to_par > 0 %}
                        +{{ player.score_to_par | int }}
                    {% else %}
                        {{ player.score_to_par | int }}
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if player.holes_played > 0 %}
                        {% if player.holes_played >= 18 %}F{% else %}{{ player.holes_played }}{% endif %}
                    {% else %}
                        {% set seconds_until_tee = player.tee_time - simulation_step %}
                        {% if seconds_until_tee > 0 %}
                            <span class="countdown">{{ seconds_until_tee }}s</span>
                        {% else %}
                            <span class="countdown">Teeing off</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td class="text-center">{{ player.r1_score_display if player.r1_score_display is not none else '-' }}</td>
                <td class="text-center">{{ player.r2_score_display if player.r2_score_display is not none else '-' }}</td>
                <td class="text-center">{{ player.r3_score_display if player.r3_score_display is not none else '-' }}</td>
                <td class="text-center">{{ player.r4_score_display if player.r4_score_display is not none else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if status == 'active' and not round_is_over %}
<script>
    setTimeout(() => {
        window.location.reload();
    }, 1000); // Refresh every 1 second
</script>
{% endif %}

{% endblock %}